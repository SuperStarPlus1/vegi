<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××©×™××•×ª ×¡×’×™×¨×ª ×¡× ×™×£ - ××¢×¨×›×ª ××œ××”</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f0f2f5;
      direction: rtl;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    header img {
      width: 150px;
      margin-bottom: 10px;
    }
    header h2 {
      font-size: 28px;
      color: #333;
    }
    .section {
      background: white;
      margin-bottom: 15px;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .text-container {
      flex: 1;
    }
    .add-image-btn {
      background: #2196f3;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      margin-right: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: transform 0.2s;
      animation: pulse 2s infinite;
    }
    .add-image-btn:hover {
      transform: scale(1.2);
    }
    .add-image-btn img {
      width: 24px;
      height: 24px;
      filter: invert(100%);
    }
    .uploading-text {
      font-size: 14px;
      color: #555;
      font-weight: bold;
      padding: 0 10px;
    }
    .preview-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .upload-status {
      margin-left: 10px;
      font-size: 20px;
      cursor: default;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .upload-status button {
      font-size: 14px;
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      border: none;
      background: #ff6b6b;
      color: white;
    }
    #taskCounter {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #2196f3;
      color: white;
      padding: 10px 20px;
      border-radius: 50px;
      font-size: 16px;
      z-index: 1000;
    }
    #progressOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      display: none;
    }
    #progressContainer {
      background: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    #progressHeader img {
      width: 150px;
      margin-bottom: 20px;
    }
    #progressText {
      font-size: 24px;
      margin-bottom: 20px;
    }
    #progressBarContainer {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: auto;
    }
    #progressBar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ffeb3b, #ffc107);
      transition: width 0.5s ease-in-out;
    }
    #whatsappInsideBtn {
      margin-top: 20px;
      background: #25d366;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 20px;
      cursor: pointer;
      display: none;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 5px yellow; }
      50% { box-shadow: 0 0 15px yellow; }
      100% { box-shadow: 0 0 5px yellow; }
    }
  </style>
</head>
<body>
  <script>
    // ×”×ª×¨××” ×‘×¤×ª×™×—×ª ×”×˜×•×¤×¡
    window.onload = function() {
      alert("×œ×‘×™×¦×•×¢×™× ××™×˜×‘×™×™× ×¢×“×™×£ ×œ×”×ª×—×‘×¨ ×œ×¨×©×ª ×”××œ×—×•×˜×™×ª. ×œ×œ× ×—×™×‘×•×¨ ×ª×™×ª×›×Ÿ ××™×˜×™×•×ª ×‘×˜×¢×™× ×ª ×ª××•× ×•×ª");
    }
  </script>
  <div id="taskCounter">××©×™××•×ª ×©× ×•×ª×¨×•: 0</div>
  <div id="progressOverlay">
    <div id="progressContainer">
      <div id="progressHeader">
        <img src="logo.png" alt="Logo" />
      </div>
      <div id="progressText">××ª×—×™×œ...</div>
      <div id="progressBarContainer"><div id="progressBar"></div></div>
      <button id="whatsappInsideBtn">ğŸ“¤ ×©×œ×— ××ª ×”×“×•×— ×‘×•×•××˜×¡××¤</button>
    </div>
  </div>
  <header>
    <img src="logo.png" alt="Logo" />
    <h2>××©×™××•×ª ×¡×’×™×¨×ª ×¡× ×™×£</h2>
  </header>
  <form id="checkForm">
    <div class="section"><label>×ª××¨×™×š ×•×©×¢×”:</label><input type="text" id="dateTime" readonly /></div>
    <div class="section"><label>×©× ×¢×•×‘×“:</label><input type="text" id="employeeName" required /></div>
    <div id="checklist"></div>
    <button
      type="submit"
      style="margin-top:20px; padding: 10px 30px; font-size: 18px; background-color:#2196f3; color:white; border:none; border-radius:8px;"
    >
      ×©×œ×— ×˜×•×¤×¡ ×‘×§×¨×”
    </button>
  </form>

  <script>
    const items = [
      { text: "×œ×•×•×“× ×©×›×œ ×”×§×¨×˜×•× ×™× ×‘×“×—×¡×Ÿ", requireImage: true },
      { text: "×œ×”×•×¦×™× ×¢×’×œ×•×ª ××”××—×¡×Ÿ", requireImage: false },
      { text: "×œ×•×•×“× ×¢× ×¢×•×‘×“ ××—×œ×§×ª ×™×¨×§×•×ª ×—×™×‘×•×¨ ××œ×’×–×” ×œ×˜×¢×™× ×”", requireImage: true },
      { text: "×¡×’×™×¨×ª ×“×œ×ª ××—×¡×Ÿ ××–×¨×—×™×ª", requireImage: false },
      { text: '×›×™×‘×•×™ ××•×¨×•×ª ××"×“', requireImage: false },
      { text: "×—×™×‘×•×¨ ××›×•× ×ª ×©×˜×™×¤×” ×œ×—×©××œ", requireImage: true },
      { text: "×›×™×‘×•×™ ××•×¨ ×©×™×¨×•×ª×™×", requireImage: false },
      { text: "×›×™×‘×•×™ ××•×¨×•×ª ××§×¨×¨×™×", requireImage: false },
      { text: "×¦×™×œ×•× ×˜××¤×¨×•×˜×•×¨×ª ×©×œ ××§×¨×¨×™ ×—×œ×‘", requireImage: true },
      { text: "×¡×’×™×¨×ª ×“×œ×ª ××—×¡×Ÿ ×××¦×¢×™×ª", requireImage: false },
      { text: "×¦×™×œ×•× ×˜××¤×¨×˜×•×¨×˜×ª ×©×œ ××§×¤×™× ×¢×•××“", requireImage: true },
      { text: "××¢×‘×¨ ×‘×™×Ÿ ×”××“×¤×™× ×œ×•×•×“× ×©××™×Ÿ ×—×¨×™×’×™× ×•×œ×•×•×“× × ×™×§×™×•×Ÿ ××¢×‘×¨×™×", requireImage: false },
      { text: "×¡×’×™×¨×ª ×“×œ×ª ××—×¡×Ÿ ××—×•×¨×™×ª (×œ×™×“ ×”××§×¨×¨)", requireImage: false },
      { text: "×œ×•×•×“× ×©×›×œ ×”××§×¨×¨×™ ×’×™×‘×•×™ ×•××§×¤××™× ×¡×’×•×¨×™×", requireImage: true },
      { text: "×¦×™×œ×•× ×˜××¤×¨×˜×•×¨×•×ª ×©×œ ××§×¨×¨×™ ×’×™×‘×•×™", requireImage: true },
      { text: "×œ×•×•×“× ×©××™×Ÿ ×¢×’×œ×•×ª ×‘×ª×•×š ×”×¡×•×¤×¨", requireImage: false },
      { text: "×¤×™× ×•×™ ×¤×—×™× ×›×•×œ×œ ×¤×— ×§×•×¤×” ×¨××©×™×ª", requireImage: false },
      { text: "×›×™×‘×•×™ ××•×¨×•×ª ××—×œ×§×ª ×©×ª×™×™×” ×•×—×•××¨×™ × ×™×§×•×™", requireImage: false },
      { text: "×›×™×‘×•×™ ××–×’× ×™× ×‘×—×œ×§ ×”××—×•×¨×™", requireImage: true },
      { text: "×¦×™×œ×•× ××“×£ ×œ×—× ×•×©×œ×™×—×” ×œ××©×¨×£", requireImage: true },
      { text: "×œ×”×•×¦×™× ×¢×’×œ×ª ×—×–×¨×•×ª ×œ×—×", requireImage: true },
      { text: "×œ×•×•×“× × ×¢×™×œ×ª ×©×¢×¨ ×—×¦×¨ ××¨×’×–×™×", requireImage: false },
      { text: "×œ×•×•×“× ×©××™×Ÿ ×¢×’×œ×•×ª ×©×œ× ×‘××§×•××", requireImage: false },
      { text: "×›×™×‘×•×™ ××–×’× ×™×", requireImage: true },
      { text: "×›×™×‘×•×™ ××•×¨×•×ª ×›× ×™×¡×” ×•×”×“×œ×§×ª ×ª××•×¨×ª ×œ×™×œ×”", requireImage: false },
      { text: "×›×™×‘×•×™ ××•×¨×•×ª ×¨××©×™", requireImage: false },
      { text: "×œ×•×•×“× ×©××™×Ÿ ×”×¤×¨×¢×” ×œ×ª×¨×™×¡ ×”×¨××©×™. ×œ×¡×’×•×¨ ××ª ×”×ª×¨×™×¡ ×•×œ×•×•×“× ×©× ×¡×’×¨ ×¢×“ ×”×¡×•×£", requireImage: true }
    ];

    const now = new Date();
    document.getElementById("dateTime").value = now.toLocaleString();

    const checklistDiv = document.getElementById("checklist");
    const uploadedFiles = {};

    const folderName = now.toISOString().split("T")[0];

    async function prepareFolder() {
      const res = await fetch("/api/upload", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ folderName }),
      });
      if (!res.ok) throw new Error("Failed to prepare folder");
      return res.json();
    }

    prepareFolder()
      .then(() => {
        console.log("Folder ready for uploads");
      })
      .catch((err) => {
        alert("×©×’×™××” ×‘×”×›× ×ª ×”×ª×™×§×™×”: " + err.message);
      });

    function updateTaskCounter() {
      const total = items.length;
      let done = 0;
      for (let i = 0; i < total; i++) {
        if (document.getElementById(`item${i}`)?.checked) done++;
      }
      document.getElementById("taskCounter").innerText = `××©×™××•×ª ×©× ×•×ª×¨×•: ${total - done}`;
    }

    items.forEach((item, idx) => {
      const section = document.createElement("div");
      section.className = "section";

      const textContainer = document.createElement("div");
      textContainer.className = "text-container";
      textContainer.innerHTML = `<label><input type="checkbox" id="item${idx}"> ${item.text}</label>`;

      section.appendChild(textContainer);

      if (item.requireImage) {
        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "add-image-btn";
        addBtn.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" />';
        addBtn.onclick = () => addImage(idx);
        section.appendChild(addBtn);

        const imgContainer = document.createElement("div");
        imgContainer.id = `imgContainer${idx}`;
        section.appendChild(imgContainer);

        uploadedFiles[idx] = [];
      }

      checklistDiv.appendChild(section);
      document.getElementById(`item${idx}`).addEventListener("change", updateTaskCounter);
    });

    updateTaskCounter();

    async function uploadFile(idx, file) {
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const fileName = `item${idx}_image${uploadedFiles[idx].length + 1}.jpg`;

        const imgContainer = document.getElementById(`imgContainer${idx}`);

        // ×œ×¤× ×™ ×”×”×¢×œ××” - × ×™×§×•×™ ×”×•×“×¢×•×ª ×©×’×™××” ×§×•×“××•×ª ×•×”×¦×’×ª ×˜×§×¡×˜ "×‘×ª××•× ×” ×‘×”×¢×œ××”"
        const oldFailSpan = imgContainer.querySelector(".upload-status");
        if (oldFailSpan) oldFailSpan.remove();

        // ××—×œ×™×£ ××ª ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ×ª××•× ×” ×œ×˜×§×¡×˜ ×”×¢×œ××”
        const addBtn = imgContainer.previousSibling; // ×”×›×¤×ª×•×¨ ×”×•× ××—×•×ª ×§×•×“××ª
        if (addBtn && addBtn.classList.contains("add-image-btn")) {
          addBtn.disabled = true;
          addBtn.innerHTML = '<span class="uploading-text">×‘×ª××•× ×” ×‘×”×¢×œ××” ×× × ×”××ª×Ÿ...</span>';
        }

        try {
          const res = await fetch("/api/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ folderName, fileName, fileData: base64 }),
          });

          if (res.ok) {
            uploadedFiles[idx].push(fileName);

            const img = document.createElement("img");
            img.src = reader.result;
            img.className = "preview-img";

            imgContainer.appendChild(img);

            document.getElementById(`item${idx}`).checked = true;
            updateTaskCounter();

            // ×”×¡×¨×ª ×”×•×“×¢×•×ª ×©×’×™××” ×•×™×¦×™×¨×ª ×¡×™××•×Ÿ ×”×¦×œ×—×”
            const failSpan = imgContainer.querySelector(".upload-status");
            if (failSpan) failSpan.remove();

            const statusSpan = document.createElement("span");
            statusSpan.className = "upload-status";
            statusSpan.textContent = "âœ…";
            imgContainer.appendChild(statusSpan);

            // ××—×–×™×¨ ××ª ×›×¤×ª×•×¨ ×”×”×•×¡×¤×” ×œ××¦×‘ ×¤×¢×™×œ ×¢× ××™×™×§×•×Ÿ ××¦×œ××”
            if (addBtn) {
              addBtn.disabled = false;
              addBtn.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" />';
            }
          } else {
            throw new Error("×”×¢×œ××” × ×›×©×œ×”");
          }
        } catch (err) {
          // ×”×¡×¨×ª ×ª××•× ×•×ª ××• ×¡×˜×˜×•×¡×™× ×§×™×™××™× ×œ×¤× ×™ ×”×¦×’×ª ×”×©×’×™××”
          imgContainer.innerHTML = "";

          const failSpan = document.createElement("span");
          failSpan.className = "upload-status";
          failSpan.style.color = "red";
          failSpan.textContent = "âŒ ×”×¢×œ××” × ×›×©×œ×” ";

          const retryBtn = document.createElement("button");
          retryBtn.textContent = "× ×¡×” ×©×•×‘";
          // ×—×©×•×‘: ×¨×§ × ×™×¡×™×•×Ÿ ×—×•×–×¨ ×œ×”×¢×œ××ª ×”×ª××•× ×”, ×œ× ×©×œ×™×—×ª ×”×˜×•×¤×¡
          retryBtn.onclick = (event) => {
            event.stopPropagation();
            event.preventDefault();
            uploadFile(idx, file);
          };

          failSpan.appendChild(retryBtn);
          imgContainer.appendChild(failSpan);

          // ××—×–×™×¨ ××ª ×›×¤×ª×•×¨ ×”×”×•×¡×¤×” ×œ××¦×‘ ×¤×¢×™×œ ×¢× ××™×™×§×•×Ÿ ××¦×œ××”
          if (addBtn) {
            addBtn.disabled = false;
            addBtn.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" />';
          }
        }
      };
      reader.readAsDataURL(file);
    }

    async function addImage(idx) {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = "image/*";
      input.capture = "environment";

      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        if (uploadedFiles[idx].length >= 9) {
          alert("× ×™×ª×Ÿ ×œ×”×¢×œ×•×ª ×¢×“ 9 ×ª××•× ×•×ª ×œ×›×œ ×¡×¢×™×£ ×‘×œ×‘×“.");
          return;
        }

        await uploadFile(idx, file);
      };
      input.click();
    }

    function showProgress(stage, percent) {
      document.getElementById("progressOverlay").style.display = "flex";
      document.getElementById("progressText").innerText = stage;
      document.getElementById("progressBar").style.width = percent + "%";
    }

    document.getElementById("checkForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      /*
      for (let i = 0; i < items.length; i++) {
        if (items[i].requireImage && (!uploadedFiles[i] || uploadedFiles[i].length === 0)) {
          alert(`× ×“×¨×© ×œ×¦×¨×£ ×œ×¤×—×•×ª ×ª××•× ×” ××—×ª ×¢×‘×•×¨: ${items[i].text}`);
          return;
        }
      }
      */

      showProgress("×™×•×¦×¨ ×“×•×—...", 80);
      const sections = items.map((item, idx) => ({
        text: item.text,
        done: document.getElementById(`item${idx}`).checked,
        images: uploadedFiles[idx] || [],
        requireImage: item.requireImage, // ××•×¡×™×£ ××ª ×”×©×“×” ×œ×©×¨×ª
      }));

      const reportRes = await fetch("/api/create-report", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          folderName,
          employeeName: document.getElementById("employeeName").value,
          sections,
        }),
      });

      if (reportRes.ok) {
        const { link } = await reportRes.json();

        showProgress("×”×•×©×œ×!", 100);

        const btn = document.getElementById("whatsappInsideBtn");
        btn.style.display = "inline-block";

        // ×›×¤×ª×•×¨ ×¡×’×•×¨ ×œ×™×“ ×›×¤×ª×•×¨ ×”×•×•××˜×¡××¤
        let closeBtn = document.getElementById("closeProgressBtn");
        if (!closeBtn) {
          closeBtn = document.createElement("button");
          closeBtn.id = "closeProgressBtn";
          closeBtn.textContent = "âŒ ×¡×’×•×¨";
          closeBtn.style.marginLeft = "10px";
          closeBtn.style.fontSize = "20px";
          closeBtn.style.cursor = "pointer";
          closeBtn.style.backgroundColor = "#ff3b30"; /* ××“×•× ×©×œ ×‘×™×˜×•×œ */
          closeBtn.style.color = "white";
          closeBtn.style.border = "none";
          closeBtn.style.padding = "10px 20px";
          closeBtn.style.borderRadius = "50px";
          closeBtn.onclick = () => {
            document.getElementById("progressOverlay").style.display = "none";
          };
          btn.parentNode.appendChild(closeBtn);
        }

        btn.onclick = () => {
          window.open(
            `https://api.whatsapp.com/send?phone=972549090028&text=${encodeURIComponent(
              "× ×•×¦×¨ ×“×•×— ×—×“×©:\n" + link
            )}`,
            "_blank"
          );
          alert("×ª×•×“×” ×©×©×œ×—×ª ××ª ×”×˜×•×¤×¡!");
          document.getElementById("progressOverlay").style.display = "none";
        };
      } else {
        alert("×©×’×™××” ×‘×™×¦×™×¨×ª ×”×“×•×—.");
        document.getElementById("progressOverlay").style.display = "none";
      }
    });
  </script>
</body>
</html>
